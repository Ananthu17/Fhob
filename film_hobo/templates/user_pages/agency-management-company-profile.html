{% extends 'base.html' %}
{% load user_account_tag %}
{% load user_tracking_tag %}
{% load token static%}

{% block extracss %}
<style>
p{
    font-family: "Myraid Pro";
    font-size: 14px;
}
</style>
{% endblock %}

{% block content %}

{% get_my_token request as token %}
<input type = "hidden" value="{{token}}" name="token" id="token"/>
<!-- <input type = "hidden" value="{{request.user.get_full_name}}" name="current_user" id="current_user"/> -->
<div class="wrapper flex-grow-1">
<div class="container">
<div class="row">
<div class="col-12">
    {% if profile %}
       {% if profile.user.id == request.user.id %}
       <a href="{% url 'hobo_user:edit-agency-management-company-profile' %}">Edit</a>
       {% endif %}
       {% get_tracking_list request.user profile.user as is_tracking %}
       {% if is_tracking %}
            <input type ="hidden" name="track_id" id="track_id" value ="{{profile.user.id}}" />
            <span class="track-btn">
                <button class="btn" style="color:rgb(7, 128, 184);font-weight: bold;" id="un_track">Tracking</button>
            </span>
       {% else %}
            {% can_track request.user profile.user as can_track %}
            {% if profile.user.id != request.user.id and can_track == True %}
                    <input type ="hidden" name="track_id" id="track_id" value ="{{profile.user.id}}" />
                    <span class="track-btn">
                        <button class="btn" style="color:rgb(7, 128, 184);font-weight: bold;" id="track" class="track">Track</button>
                    </span>
            {% endif %}
        {% endif %}
        <p><b>Company Name: </b>{{user.company_name}}</p>
        <p><b>Status: </b> {{profile.user.get_membership_display}}</p>
        <p><b>Company Type: </b>
            {% if user.agency_management_type %}
                {{user.get_agency_management_type_display}}
            {% else %}
                {{user.get_company_type_display}}
            {% endif %}
        </p>
        <p><b>Company Website: </b><a href="{{user.company_website}}">{{user.company_website}}</a></p>
        {% if profile.bio %}
        <p><b>Bio </b>{{profile.bio}}</p>
        {% endif %}
        {% if profile.submission_policy_SAMR %}
        <p><b>Submission policy SAMR: </b>{{profile.get_submission_policy_SAMR_display}} </p>
        {% endif %}
        {% if staff %}<p><b>Staff: </b>
            {% for item in staff %}
                {% if item.user %}
                    <div style="font-family:Myraid Pro;font-size:14px;">
                    {% if item.user.membership != 'COM' %}
                        <a href="{% url 'hobo_user:profile' item.user.id %}"
                        target="_blank">
                    {%  elif item.user.membership == 'COM' and item.user.company_type == 'production' %}
                        <a href="{% url 'hobo_user:production-company-profile' item.user.id %}"
                        target="_blank">
                    {%  elif item.user.membership == 'COM' and item.user.company_type == 'agency_management' %}
                        <a href="{% url 'hobo_user:agency-management-company-profile' item.user.id %}" target="_blank" >
                    {% endif %}
                        {{ item.name }}({{item.position}})</a></div>
                {% else %}
                    <div style="font-family:Myraid Pro;font-size:14px;">{{ item.name }}({{item.position}})</div>
                {% endif %}
            {% endfor %}</p>
        {% endif %}
        {% if client_dict %}
            <div class="row">
            {% for position,clients in client_dict.items %}
                <div class="col-12 mem-setup-blu-f">{{position}}</div>
                {% for client in clients %}
                <div class="col-1">
                {% if client.user %}
                    {% if client.user.membership != 'COM' %}
                        <a href="{% url 'hobo_user:profile' client.user.id %}"
                        target="_blank">
                    {%  elif client.user.membership == 'COM' and client.user.company_type == 'production' %}
                        <a href="{% url 'hobo_user:production-company-profile' client.user.id %}"
                        target="_blank">
                    {%  elif client.user.membership == 'COM' and client.user.company_type == 'agency_management' %}
                        <a href="{% url 'hobo_user:agency-management-company-profile' client.user.id %}" target="_blank" >
                    {% endif %}
                    <img src ="{{ client.user.get_profile_photo }}" class="client-img"/>
                    {{client.name|truncatechars:"5"}}</a>
                {% else %}
                    <img src ="{% static 'images/default_profile_pic.png' %}" class="client-img"/>
                    {{client.name|truncatechars:"5"}}
                {% endif %}

            </div>
            {% endfor %}
            {% endfor %}
        </div>
        {% endif %}

    {% else %}
        <p>{{message}}</p>
    {% endif %}

</div>
</div>
</div>
</div>


{% endblock %}

{% block extrajs %}
<script>
// var room_name = $("#room_name").val();
// var token = $("#profile_token").val();
// var connectionString = 'ws://' + window.location.host+'/ws/notification/'+token + '/';
// console.log(connectionString)
// var notificationSocket = new WebSocket(connectionString);

    $('body').on('click' , '#track', function(){
        var token = $("#token").val();
        // var user = $("#current_user").val();
        var track_id = $("#track_id").val();
        var data_dict = {}
        data_dict['track_id'] = track_id;
        // console.log(track_id)
        $.ajax
        ({
            type: "POST",
            url: "/hobo_user/track-user-api/",
            dataType: 'json',
            async: false,
            data: data_dict,
            beforeSend: function (xhr) {
                xhr.setRequestHeader ("Authorization", token);
            },
            success: function (response){
                $('.track-btn').html(" ")
                $('.track-btn').html("<button class='btn' style='color:rgb(7, 128, 184);font-weight: bold;' id='un_track'>Tracking</button>");
            }
        });
    });
</script>
<script>
    $('body').on('click' , '#un_track', function(){
        var token = $("#token").val();
        var track_id = $("#track_id").val();
        var data_dict = {}
        data_dict['track_id'] = track_id;
        // console.log(track_id)
        $.ajax
        ({
            type: "POST",
            url: "/hobo_user/untrack-user-api/",
            dataType: 'json',
            async: false,
            data: data_dict,
            beforeSend: function (xhr) {
                xhr.setRequestHeader ("Authorization", token);
            },
            success: function (response){
                $('.track-btn').html(" ")
                $('.track-btn').html("<button class='btn' style='color:rgb(7, 128, 184);font-weight: bold;' id='track' class='track'>Track</button>");
            }
        });
    });
</script>
{% endblock %}


